!function(e,t){var o=function(e){if(!(this instanceof o))throw new Error("Must instantiate using the `new` keyword");if("object"!=typeof e.targets||0===e.targets.length)throw new Error("Invalid or missing target element(s)");if("function"!=typeof e.save)throw new Error("Invalid or missing save callback");var r={form_id:"frmb-"+Date.now(),startingModel:!1,targets:!1,save:!1,lang:"en",sortable:!0,templateBasePath:"templates/builder",field_types:[{key:"text",label:"Text",schema:{name:!1,fbid:!1,label:"",required:!1}},{key:"textarea",label:"Textarea",schema:{name:!1,fbid:!1,label:"",required:!1}},{key:"select",label:"Select",template:"choices",schema:{name:!1,fbid:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}},{key:"radio",label:"Radio",template:"choices",schema:{name:!1,fbid:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}},{key:"checkbox",label:"Checkbox",template:"choices",schema:{name:!1,fbid:!1,label:"",required:!1,choices:[]},choiceSchema:{selected:!1,label:""}}]},i=this;this._opts=$.extend(!0,{},r,e),dust.onLoad===t&&(dust.onLoad=function(e,o){$.ajax(i._opts.templateBasePath+"/"+i._opts.lang+"_"+e+".tpl",{success:function(e){o(t,e)},error:function(e,r){o(r,t)}})});var a=function(e){var t=[];for(var o in e)e.hasOwnProperty(o)&&t.push({key:o,value:e[o].sortOrder});t.sort(function(e,t){return e.value-t.value});for(var r=[],i=0,a=t.length;a>i;i++){var n=t[i].key;r.push(e[n])}return r};return function(e){var t=e._opts.targets;if(e.render(),"object"==typeof e._opts.startingModel){e._model=e._opts.startingModel;var o=a(e._model);$.each(o,function(t,o){var r=e.getFieldTypeByName(o.type);e.addFormElementEditor(r,o)})}t.on("change",".frmb-add-elem",function(){var t=$(this).val();e.addFormElementEditor(e.getFieldTypeByName(t)),$(this).val("")}),t.on("click",".frmb-add-choice",function(t){t.preventDefault();var o=$(this),r=o.parents(".frmb-group").last(),i=r.attr("id"),a=e.getFieldTypeByName(e._model[i].type);return e.appendFieldToFormElementEditor(r,a,e._model[i]),!1}),t.on("click",".frmb-remove",function(t){t.preventDefault();var o=$(this),r=o.parents(".frmb-group:eq(0)"),i=r.attr("id");return e.removeModel(i),r.remove(),!1}),t.on("click",".frmb-choice-remove",function(t){t.preventDefault();var o=$(this),r=o.parents(".frmb-choice-group:eq(0)"),i=r.attr("id");return e.removeModel(i),r.remove(),!1}),t.on("keyup","input[type=text]",function(){var t=$(this),o=t.parents(".frmb-group").last(),r=o.attr("id"),i=t.attr("name").replace(r+"_","");e.setModelValue(r,i,t.val())}),t.on("change","input[type=checkbox]",function(){var t=$(this),o=t.parents(".frmb-group").last(),r=o.attr("id"),i=t.attr("name").replace(r+"_","");e.setModelValue(r,i,t.is(":checked"))}),t.on("click",".frmb-save",function(t){return t.preventDefault(),e.save(),!1})}(this),this};o.prototype={_opts:!1,_model:{},render:function(){var e=this,t={field_types:this._opts.field_types};dust.render("base",t,function(t,o){e._opts.targets.append(o)})},getFieldTypeByName:function(e){for(var t=null,o=0,r=this._opts.field_types.length;r>o;o++){var i=this._opts.field_types[o];if(i.key===e){t=i;break}}return t},addFormElementEditor:function(e,o){var r=this;if("object"!=typeof e)throw new Error("Failed to add form element editor: Invalid field object");var i=e.key+"_"+Date.now();o!==t&&"string"==typeof o.fbid?i=o.fbid:"string"==typeof e.fbid&&(i=e.fbid),"object"!=typeof o&&(r._model[i]=$.extend(!0,{},e.schema,{fbid:i,type:e.key}),o=r._model[i]);var a={fbid:i,model:o,allowsChoices:o.choices!==t};a=$.extend(!0,{},a,e),dust.render("element-base",a,function(i,a){var n=$(a),l=r._opts.targets.find("ul"),d=l.find(".frmb-group:last");return 0!==d.length?d.after(n):l.append(n),r._opts.sortable&&r._opts.targets.find("ul").sortable(),o.choices!==t?void $.each(o.choices,function(t,i){r.appendFieldToFormElementEditor(n,e,o,i,t)}):void r.appendFieldToFormElementEditor(n,e,o)})},updateModelWithSort:function(){var e=this,o=e._opts.targets.find(".frmb-group"),r=1;$.each(o,function(o,i){var a=$(i).attr("id");e._model[a]!==t&&(e._model[a].sortOrder=r),r++})},appendFieldToFormElementEditor:function(e,o,r,i,a){if(o.template!==t&&r.choices!==t){"object"!=typeof i&&(i=$.extend(!0,{},o.choiceSchema),r.choices.push(i));var n={fbid:r.fbid,model:i};a="number"==typeof a?a:r.choices.length,n.fbid+="_choices."+a,dust.render(o.template,n,function(t,o){e.find(".frmb-choices").append(o)})}},setModelValue:function(e,o,r){var i=!1;if(o.indexOf(".")>-1&&(i=o.split("."),o=i[0]),this._model[e]===t)throw new Error("Model has no entry for "+e);if(this._model[e].type===t)throw new Error("Invalid schema field "+o+" for model "+e);this.getFieldTypeByName(this._model[e].type);if("choices"===o){var a=parseInt(i[1],10)-1;if(this._model[e][o][a][i[2]]===t)throw new Error("Invalid choice schema field "+i[2]+" for model "+e);return void(this._model[e][o][a][i[2]]=r)}this._model[e][o]=r},removeModel:function(e){if(e.indexOf(".")>-1){var t=e.replace(/.*_/,""),o=t.split("."),r=parseInt(o[1],10);return e=e.replace("_"+t,""),void delete this._model[e][o[0]][r]}delete this._model[e]},setFieldNames:function(){var e=this;for(var t in e._model){var o=e._model[t];("string"!=typeof o.name||0===o.name.trim().length)&&(e._model[t].name=o.label.toLowerCase().replace(/([^a-zA-Z0-9\._-]+)/g,"-"))}},save:function(){this.updateModelWithSort(),this.setFieldNames();({form_id:this._opts.form_id,model:this._model});this._opts.save({form_id:this._opts.form_id,model:this._model})}},e.Formbuilder=o}(this);