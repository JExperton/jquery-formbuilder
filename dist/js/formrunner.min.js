var Formrunner=function(e){if("object"!=typeof e.targets||0===e.targets.length)throw new Error("Invalid or missing target element(s)");var t={form_id:!1,model:!1,targets:!1,action:"",method:"POST",lang:"en",templateBasePath:"templates/runner"},n=this;return this._opts=$.extend(!0,{},t,e),void 0===dust.onLoad&&(dust.onLoad=function(e,t){$.ajax(n._opts.templateBasePath+"/"+n._opts.lang+"_"+e+".tpl",{success:function(e){t(void 0,e)},error:function(e,n){t(n,void 0)}})}),this.render(),this},sortObject=function(e){var t=[];for(var n in e)e.hasOwnProperty(n)&&t.push({key:n,value:e[n].sortOrder});t.sort(function(e,t){return e.value-t.value});for(var o=[],r=0,a=t.length;a>r;r++){var s=t[r].key;o.push(e[s])}return o};Formrunner.prototype={_opts:!1,render:function(){var e=this,t={form_id:e._opts.form_id,action:e._opts.action,method:e._opts.method};dust.render("base",t,function(t,n){var o=$(n).appendTo(e._opts.targets),r=o.find(".fields-wrapper");0==r.length&&(r=$("<div>",{"class":"fields-wrapper"}).prependTo(o));var a=sortObject(e._opts.model);$.each(a,function(t,n){e.appendElementForModel(n,r)}),e._opts.csrf_token&&r.prepend('<input type="hidden" name="'+e._opts.csrf_token.name+'" value="'+e._opts.csrf_token.value+'">')})},appendElementForModel:function(e,t){var n=this,o={id:n.fieldNameToId(e.label),label:e.label,required:e.required};dust.render(e.type,o,function(o,r){var a=$(r).appendTo(t);void 0!==e.choices&&e.choices.length>0&&$.each(e.choices,function(t,o){o.id=n.fieldNameToId(o.label),o.name=n.fieldNameToId(e.label),dust.render(e.type+"-choices",o,function(t,n){"select"===e.type?a.find("select").append(n):a.find(".frmb-choices").append(n)})})})},fieldNameToId:function(e){return e.toLowerCase().replace(/ /g,"-").replace(/[^a-zA-Z0-9_.-]/g,"")}};