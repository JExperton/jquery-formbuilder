var Formrunner=function(e){if("object"!=typeof e.targets||0===e.targets.length)throw new Error("Invalid or missing target element(s)");var t={form_id:!1,model:!1,targets:!1,action:"",method:"POST",lang:"en",templateBasePath:"templates/runner"},r=this;return this._opts=$.extend(!0,{},t,e),void 0===dust.onLoad&&(dust.onLoad=function(e,t){$.ajax(r._opts.templateBasePath+"/"+r._opts.lang+"_"+e+".tpl",{success:function(e){t(void 0,e)},error:function(e,r){t(r,void 0)}})}),this.render(),this},sortObject=function(e){var t=[];for(var r in e)e.hasOwnProperty(r)&&t.push({key:r,value:e[r].sortOrder});t.sort(function(e,t){return e.value-t.value});for(var n=[],o=0,a=t.length;a>o;o++){var d=t[o].key;n.push(e[d])}return n};Formrunner.prototype={_opts:!1,render:function(){var e=this,t={form_id:e._opts.form_id,action:e._opts.action,method:e._opts.method};dust.render("base",t,function(t,r){var n=$(r).appendTo(e._opts.targets),o=n.find(".fields-wrapper");0==o.length&&(o=$("<div>",{"class":"fields-wrapper"}).prependTo(n));var a=sortObject(e._opts.model);$.each(a,function(t,r){e.appendElementForModel(r,o)}),e._opts.extra_fields&&$.each(e._opts.extra_fields,function(e,t){o.prepend('<input type="hidden" name="'+e+'" value="'+t+'">')})})},appendElementForModel:function(e,t){var r=this,n={id:r.fieldNameToId(e.label),label:e.label,required:e.required};dust.render(e.type,n,function(n,o){var a=$(o).appendTo(t);void 0!==e.choices&&e.choices.length>0&&$.each(e.choices,function(t,n){n.id=r.fieldNameToId(n.label),n.name=r.fieldNameToId(e.label),dust.render(e.type+"-choices",n,function(t,r){"select"===e.type?a.find("select").append(r):a.find(".frmb-choices").append(r)})})})},fieldNameToId:function(e){return e.toLowerCase().replace(/ /g,"-").replace(/[^a-zA-Z0-9_.-]/g,"")}};